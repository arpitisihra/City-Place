<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Escape City Palace</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: sans-serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 2rem;
    }
    .choices {
      margin-top: 2rem;
    }
    button {
      background-color: black;
      color: white;
      border: 1px solid white;
      padding: 1rem;
      margin: 0.5rem 0;
      width: 100%;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #222;
    }
  </style>
  <!-- Firebase SDKs for Analytics and Firestore -->
  <script type="module">
    // Import the functions needed from Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js"; // Core Firebase app
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js"; // Authentication
    import { getFirestore, doc, setDoc, increment } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js"; // Firestore Database

    // IMPORTANT: These variables are automatically provided by the Canvas environment for the dashboard.
    // For your game running locally, we'll use your provided firebaseConfig.
    // However, we still need to reference these to avoid errors if running in a Canvas-like iframe.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Your specific Firebase configuration from the console - NOW CORRECTLY USING YOUR LATEST API KEY!
    const firebaseConfig = {
      apiKey: "AIzaSyCgVxPXrdF8Jnkp7L2ANnelhikQRmoxaOc", // <--- THIS IS YOUR LATEST KEY!
      authDomain: "cyoa-games-analytics-project.firebaseapp.com",
      projectId: "cyoa-games-analytics-project",
      storageBucket: "cyoa-games-analytics-project.firebasestorage.app",
      messagingSenderId: "478639179033",
      appId: "1:478639179033:web:8125ad58e38184c4e3f188",
      measurementId: "G-V8CCQ2JGWG" // This is for Google Analytics, but not directly used by our Firestore logging
    };

    // Declare global variables attached to `window` for access from other scripts
    window.app = null;
    window.db = null;
    window.auth = null;
    window.userId = null;

    // New: A promise that resolves when Firebase is fully initialized and authenticated
    let firebaseReadyResolve;
    const firebaseReadyPromise = new Promise(resolve => {
      firebaseReadyResolve = resolve;
    });

    // Initialize Firebase app and services after the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize the Firebase app with your specific configuration
      window.app = initializeApp(firebaseConfig);
      // Get instances of Firestore and Authentication services
      window.db = getFirestore(window.app);
      window.auth = getAuth(window.app);

      try {
        // Authenticate the user. Use custom token if available (from Canvas), otherwise sign in anonymously.
        if (initialAuthToken) {
          await signInWithCustomToken(window.auth, initialAuthToken);
        } else {
          await signInAnonymously(window.auth);
        }
        window.userId = window.auth.currentUser?.uid; // Store the authenticated user's ID
        console.log("Firebase initialized and authenticated successfully. User ID:", window.userId);
        firebaseReadyResolve(); // Resolve the promise once ready!
      } catch (error) {
        console.error("Firebase authentication failed during game setup:", error);
        // Do NOT resolve firebaseReadyPromise here if authentication fails,
        // so analytics calls will continue to wait or fail gracefully.
      }
    });

    // --- Analytics Functions for Firestore ---
    // These functions are exposed globally (window.log...) so your game logic can call them.

    // Helper function to update Firestore documents for analytics
    async function updateAnalytics(gameId, dataToUpdate) {
        // Wait for Firebase to be fully initialized and authenticated before proceeding
        await firebaseReadyPromise;

        // Double-check readiness after the promise resolves, in case of auth failure
        // (e.g., if authentication itself failed despite promise resolving due to other errors)
        if (!window.db || !window.userId) {
            console.error("Firebase is not ready for analytics. Database or user ID is missing after readiness check. Data will not be sent.");
            return;
        }

        // Reference to the specific game document in the public analytics collection
        const docRef = doc(window.db, `artifacts/${appId}/public/data/gameAnalytics`, gameId); // Use window.db
        try {
            // Use setDoc with { merge: true } to create the document if it doesn't exist,
            // or update it by merging new data without overwriting existing fields.
            await setDoc(docRef, dataToUpdate, { merge: true });
            console.log("Analytics data sent:", gameId, dataToUpdate); // Uncomment for detailed logging
        } catch (e) {
            console.error("Failed to send analytics data to Firestore:", e);
        }
    }

    // Logs when a game starts
    window.logGameStarted = async (gameId) => {
      await updateAnalytics(gameId, { totalStarts: increment(1) });
    };

    // Logs when a player reaches a specific step
    window.logStepReached = async (gameId, stepId) => {
      const stepPath = `stepReached.${stepId}`; // Use dot notation to update a specific property within the 'stepReached' map
      await updateAnalytics(gameId, { [stepPath]: increment(1) });
    };

    // Logs when a player dies at a specific step
    window.logPlayerDied = async (gameId, stepId, causeOfDeath) => {
      const deathPath = `deathSteps.${stepId}`; // Use dot notation for the 'deathSteps' map
      await updateAnalytics(gameId, { [deathPath]: increment(1) });
    };

    // Logs when a game is completed successfully
    window.logGameWon = async (gameId) => {
      await updateAnalytics(gameId, { totalWins: increment(1) });
    };
  </script>
</head>
<body>
  <h1>Escape City Palace</h1>
  <div id="story"></div>
  <div class="choices" id="choices"></div>

  <script type="text/javascript">
    // Define a unique ID for this game - IMPORTANT: CHANGE THIS FOR EACH NEW GAME!
    // Example: "ancient_ruins_adventure", "forest_mystery_game"
    const GAME_ID = "escape_city_palace"; 
    
    // The story data is embedded directly in the script
    const storyData = {
      "steps": [
        {
          "id": 1,
          "text": "You enter a forgotten library in the old city. A strange force pulls you toward a shelf. A black-cloth-wrapped book lies pulsing shining in the corner.",
          "choices": [
            { "text": "Proceed", "next_step": 2 }
          ]
        },
        {
          "id": 2,
          "text": "You unwrap the book. It’s titled 'The Cursed City Palace of Jaipur'. The pages are blank. You try to close it, but it flips open on its own.",
          "choices": [
            { "text": "Proceed", "next_step": 3 }
          ]
        },
        {
          "id": 3,
          "text": "The page reads: 'You wanted the cursed City Palace. I’ll take you there.' Your body rises. Wind howls. A vortex forms — you’re sucked in.",
          "choices": [
            { "text": "Proceed", "next_step": 4 }
          ]
        },
        {
          "id": 4,
          "text": "You find yourself at Mubarak Mahal under a moonlit sky. The palace is empty and silent. You feel eyes watching.",
          "choices": [
            { "text": "Move towards the building", "next_step": 5 },
            { "text": "Walk out of the gate behind you", "death": "You're dragged into the darkness by spirits of old pehredaars and killed." }
          ]
        },
        {
          "id": 5,
          "text": "You walk towards the building. No one’s there but you hear whispers in Marwari.",
          "choices": [
            { "text": "Speak back to the voices", "death": "You mispronounce something in Marwari and are struck by a flying mace. You die on the spot." },
            { "text": "Step back slowly and cross to Sileh Khana", "next_step": 6 }
          ]
        },
        {
          "id": 6,
          "text": "You reach Sileh Khana. Weapons float and clash mid-air. Ghosts of warriors without faces duel. One turns and stares at you.",
          "choices": [
            { "text": "Run towards Diwan-i-Aam", "next_step": 7 },
            { "text": "Try to speak with gestures with the warrior", "death": "The warrior ghost slits your throat with his sword." }
          ]
        },
        {
          "id": 7,
          "text": "You enter Diwan-i-Aam. The throne is empty, but footsteps surround you.",
          "choices": [
            { "text": "Kneel and pretend to be a servant", "death": "You're trampled by ghost nobles and your throat is slit opened" },
            { "text": "Crawl behind the pillar and hide", "next_step": 8 }
          ]
        },
        {
          "id": 8,
          "text": "The ghost of king's bodyguard sees you from behind the throne. 'Are you looking for help,' he says.",
          "choices": [
            { "text": "Run through the open corridor", "next_step": 9 },
            { "text": "Run to him for help", "death": "Ghosts jump from the ceiling and hang you with an invisible rope." }
          ]
        },
        {
          "id": 9,
          "text": "You’re now near Rajendra Pol and ghosts are chasing you. You see two giant Silver Vessels glimmer.",
          "choices": [
            { "text": "Hide inside a vessel", "next_step": 10 },
            { "text": "Run towards Chandra Mahal", "death": "You're hit by an arrow to the heart. You're dead" }
          ]
        },
        {
          "id": 10,
          "text": "Inside the vessel, you find the King's lighter. You flick it on. An inscription on the vessel reads: Above the moon, beyond the fire — the mantra lies on Chandra’s spire. Speak it to awaken the sleeping gods.",
          "choices": [
            { "text": "Stay hidden in the vessel", "death": "The ghosts run you down and attack you with maces and knives. You bleed to death." },
            { "text": "Run towards Chandra Mahal", "next_step": 11 }
          ]
        },
        {
          "id": 11,
          "text": "The inscription you read shakes the palace compound like an earthquake. A chant echoes from afar.",
          "choices": [
            { "text": "Keep running", "next_step": 12 },
            { "text": "Wait for the shaking to stop", "death": "Shadows jump on you from above and break your neck. You die a painful death." }
          ]
        },
        {
          "id": 12,
          "text": "You step out and find a statue of a warrior on a horse.",
          "choices": [
            { "text": "Bow down", "next_step": 13 },
            { "text": "Try to get the sword out of the warrior's hand", "death": "The warrior comes to life and breaks your skull with his sword. You bleed your brains out and die." }
          ]
        },
        {
          "id": 13,
          "text": "The statue disappeared. You run and reach Ridhi Sidhi Pol. The arch pulses with strange red light. You see a small child crying loudly.",
          "choices": [
            { "text": "Turn back and run fast", "next_step": 14 },
            { "text": "Move forward and take care of the child", "death": "The child turns into a beast and bites your neck off. You die a painful death." }
          ]
        },
        {
          "id": 14,
          "text": "You've reached Pritam Chowk and see four season-painted doors. All slam shut, you hear a voice - You can only choose one door.",
          "choices": [
            { "text": "Choose the blue door", "next_step": 15 },
            { "text": "Choose the red door", "death": "You enter the door and fall into a fire pit and die." }
          ]
        },
        {
          "id": 15,
          "text": "The blue door opens on its own and you walk in and find a mirror room. A giant mirror has something written on it in Sanskrit.",
          "choices": [
            { "text": "Shatter the mirror", "next_step": 16 },
            { "text": "Read out loud what's written on the mirror", "death": "It's a mantra to kill whoever reads it, you're sucked into mirror world and cut into pieces." }
          ]
        },
        {
          "id": 16,
          "text": "The shattered mirror makes way for you into The Chamber of Whispers. You hear whispers offering you advise and help.",
          "choices": [
            { "text": "Chant 'Stay quiet for some time'", "next_step": 17 },
            { "text": "Ask for help", "death": "They are the whispers of cursed daasis who drag your body out and crush your skull with stones " }
          ]
        },
        {
          "id": 17,
          "text": "The whispers vanish after some time. A ghost of a palace worker appears, holding out a key to the lock on the door.",
          "choices": [
            { "text": "Accept it respectfully", "next_step": 18 },
            { "text": "Touch his feet", "death": "The ghost hits you with a dagger in your spine. You die a painful death." }
          ]
        },
        {
          "id": 18,
          "text": "You use the key on a locked room. Inside, you see a floating conch.",
          "choices": [
            { "text": "Blow the conch", "next_step": 19 },
            { "text": "Smash it", "death": "Your ears explode from a million screams. You suffer a heart attack and die." }
          ]
        },
        {
          "id": 19,
          "text": "A stairway appears leading up, carved into the wall.",
          "choices": [
            { "text": "Light your way with the lighter", "next_step": 20 },
            { "text": "Walk in darkness", "death": "You fall into a deep stone chamber and die." }
          ]
        },
        {
          "id": 20,
          "text": "The walls are painted with war scenes. The eyes of painted soldiers move.",
          "choices": [
            { "text": "Bow and walk humbly", "next_step": 21 },
            { "text": "Ask the soldiers the way to Chandra Mahal", "death": "The soldiers come out of the painting and cut your throat off with their swords. You're dead." }
          ]
        },
        {
          "id": 21,
          "text": "You reach a chamber full of gold coins.",
          "choices": [
            { "text": "Keep walking", "next_step": 22 },
            { "text": "Grab a coin and run", "death": "The Djinn guarding the treasure appears and hits your head with a spear. You're dead." }
          ]
        },
        {
          "id": 22,
          "text": "You ascend Chandra Mahal. The halls twist unnaturally.",
          "choices": [
            { "text": "Mark your path with blood", "next_step": 23 },
            { "text": "Leave no markings", "death": "You get lost in an endless loop and die after a few days."
            }
          ]
        },
        {
          "id": 23,
          "text": "A royal woman glides past with a baby in her hands, humming a lullaby. They're both headless.",
          "choices": [
            { "text": "Bow silently and run towards the opposite side", "next_step": 24 },
            { "text": "Follow them and find a way", "death": "They suddenly grow heads and their screams fetch your soul away. You're dead" }
          ]
        },
        {
          "id": 24,
          "text": "You reach a corner and the find a red cloth with a Mantra in Sanskrit",
          "choices": [
            { "text": "Memorize it and run fast", "next_step": 25 },
            { "text": "Grab the cloth and run", "death": "The cloth ties itself around your neck and lift your body up in the air. Your dead body hangs in the air till it rots." }
          ]
        },
        {
          "id": 25,
          "text": "You run while speaking the mantra. The wind picks up violently. You reach another door and a voice whispers, 'Only the pure heart may pass.'",
          "choices": [
            { "text": "Bow down and ask to be let go", "next_step": 26 },
            { "text": "Tell them you have a pure heart", "death": "The ghost of the guard caught a lie and hit you with a mace. You're dead" }
          ]
        },
        {
          "id": 26,
          "text": "A door opens, but the second one blocks the rooftop. It requires a sacrifice.",
          "choices": [
            { "text": "Offer a drop of your blood", "next_step": 27 },
            { "text": "Offer the lighter", "death": "It's rejected and you're thrown down the stairs. You die" }
          ]
        },
        {
          "id": 27,
          "text": "You step onto the rooftop of Chandra Mahal. The final mantra is inscribed on a stone. There's also a brick of gold with something written on it",
          "choices": [
            { "text": "Chant the mantra", "next_step": 28 },
            { "text": "Read what's written on the gold brick", "death": "The brick rises in the air and hits you in the head. You bleed to death." }
          ]
        },
        {
          "id": 28,
          "text": "As you start speaking the mantra, the spirits scream. The ground shakes. Light bursts from the sky.",
          "choices": [
            { "text": "Keep chanting the mantra", "next_step": 29 },
            { "text": "Look up in the sky", "death": "You're sucked into the clouds of spirits. Your spirit is now their slave" }
          ]
        },
        {
          "id": 29,
          "text": "As you chant the mantra, you rise into the sky. The vortex returns. Faces of the cursed reach for you.",
          "choices": [
            { "text": "Fold hands and offer them peace", "next_step": 30 },
            { "text": "Chant the Mantra loudly at them", "death": "They reach for your soul and pull it out, dragging you into eternal torment. You collapse beneath the sky." }
          ]
        },
        {
          "id": 30,
          "text": "You keep rising up, your eyes feel heavy and you close them. A few moments later, you wake up in the library. The book is closed beside you. One drop of blood stains the page. Congrats, you survived.",
          "is_ending": true,
          "is_death": false,
          "choices": [
            { "text": "Restart / Share Your Ending", "next_step": 1 }
          ]
        }
      ]
    };

    let steps = [];
    let currentStep = 1;

    document.addEventListener('DOMContentLoaded', () => {
      steps = storyData.steps;
      
      // Attempt to log game started. This will now wait for Firebase to be ready internally.
      if (typeof window.logGameStarted === 'function') {
        window.logGameStarted(GAME_ID);
        console.log("Attempting to log game started...");
      } else {
        console.warn("Analytics function logGameStarted not available. Firebase SDK might not be loaded correctly.");
      }
      showStep(currentStep); // Show the first step immediately
    });

    function showStep(stepId) {
      const step = steps.find(s => s.id === stepId);
      if (!step) {
        document.getElementById("story").innerText = "An error occurred: Story step not found.";
        return;
      }

      currentStep = stepId;
      // Log that this step has been reached
      if (typeof window.logStepReached === 'function') {
        window.logStepReached(GAME_ID, stepId);
      } else {
        console.warn("Analytics function logStepReached not available. Ensure Firebase SDK is loaded.");
      }
      
      document.getElementById("story").innerText = step.text;
      const choicesDiv = document.getElementById("choices");
      choicesDiv.innerHTML = "";

      // Randomize the order of choices for difficulty
      const shuffledChoices = [...step.choices].sort(() => Math.random() - 0.5);

      shuffledChoices.forEach(choice => {
        const button = document.createElement("button");
        button.innerText = choice.text;
        button.onclick = () => {
          if (choice.next_step) {
            // Check if this is a winning step (Step 30 is the win condition)
            if (step.is_ending && !step.is_death) {
              if (typeof window.logGameWon === 'function') {
                window.logGameWon(GAME_ID);
              } else {
                console.warn("Analytics function logGameWon not available. Ensure Firebase SDK is loaded.");
              }
            }
            showStep(choice.next_step);
          } else {
            // Log player death before showing the death message
            if (typeof window.logPlayerDied === 'function') {
              window.logPlayerDied(GAME_ID, currentStep, choice.death || "Unknown cause");
            } else {
              console.warn("Analytics function logPlayerDied not available. Ensure Firebase SDK is loaded.");
            }
            showDeath(choice.death || "You have died.");
          }
        };
        choicesDiv.appendChild(button);
      });
    }

    function showDeath(deathMessage) {
      document.getElementById("story").innerText = deathMessage;
      const choicesDiv = document.getElementById("choices");
      choicesDiv.innerHTML = "";

      const restartButton = document.createElement("button");
      restartButton.innerText = "Restart";
      restartButton.onclick = () => {
        // When players die, the game restarts from step 4
        currentStep = 4;
        // Log game started again for new playthrough
        if (typeof window.logGameStarted === 'function') {
          window.logGameStarted(GAME_ID);
        } else {
          console.warn("Analytics function logGameStarted not available on restart. Ensure Firebase SDK is loaded.");
        }
        showStep(currentStep);
      };
      choicesDiv.appendChild(restartButton);
    }
  </script>
</body>
</html>
